<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>بوابة الاستعلام عن جدول الاختبارات</title>
<style>
  :root{
    --bg1:#f7fbff;
    --bg2:#eef5ff;
    --card:#ffffffcc;
    --text:#0f172a;
    --muted:#64748b;
    --primary:#2563eb;
    --primary2:#1d4ed8;
    --danger:#dc2626;
    --danger2:#b91c1c;
    --border:#e5e7eb;
    --shadow:0 18px 45px rgba(2,6,23,.10);
    --radius:18px;
  }
  body{
    margin:0;
    font-family:Tahoma,Arial,sans-serif;
    color:var(--text);
    background: radial-gradient(1200px 600px at 20% 10%, #dbeafe 0%, transparent 55%),
                radial-gradient(900px 500px at 80% 0%, #e0f2fe 0%, transparent 55%),
                linear-gradient(180deg, var(--bg2), var(--bg1));
    min-height:100vh;
  }
  .wrap{
    max-width:1180px;
    margin:26px auto;
    padding:0 14px;
  }
  .topbar{
    background:var(--card);
    backdrop-filter: blur(10px);
    border:1px solid #ffffff80;
    box-shadow:var(--shadow);
    border-radius:22px;
    padding:18px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
  }
  .brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo{
    width:56px;height:56px;
    border-radius:16px;
    background:linear-gradient(135deg,#e0f2fe,#dbeafe);
    border:1px solid #ffffff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    color:#0b3ea8;
  }
  .title h1{
    margin:0;
    font-size:22px;
    letter-spacing:.2px;
  }
  .title .sub{
    margin-top:4px;
    font-size:13px;
    color:var(--muted);
  }
  .pills{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-start;
  }
  .pill{
    border:1px solid var(--border);
    background:#fff;
    padding:8px 12px;
    border-radius:999px;
    font-size:13px;
    color:#1f2937;
  }

  .card{
    margin-top:18px;
    background:var(--card);
    border:1px solid #ffffff80;
    backdrop-filter: blur(10px);
    box-shadow:var(--shadow);
    border-radius:var(--radius);
    padding:18px;
  }

  .row{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
  }
  input{
    width:min(720px, 92vw);
    padding:14px 14px;
    border-radius:16px;
    border:1px solid var(--border);
    font-size:16px;
    outline:none;
  }
  input:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.12); }
  .btn{
    padding:12px 16px;
    border-radius:14px;
    border:none;
    cursor:pointer;
    font-size:15px;
    font-weight:700;
    background:var(--primary);
    color:#fff;
  }
  .btn:hover{ background:var(--primary2); }
  .hint{
    text-align:center;
    margin-top:10px;
    color:var(--muted);
    font-size:13px;
  }

  .info{
    margin-top:14px;
    background:linear-gradient(180deg,#eff6ff,#ffffff);
    border:1px solid #dbeafe;
    padding:14px;
    border-radius:16px;
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    justify-content:space-between;
  }
  .info .box{
    flex:1;
    min-width:240px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
  }
  .info .label{ font-size:12px; color:var(--muted); }
  .info .value{ font-size:18px; font-weight:800; margin-top:6px; }

  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    margin-top:14px;
    overflow:hidden;
    border-radius:16px;
    border:1px solid var(--border);
    background:#fff;
  }
  th,td{
    padding:12px 10px;
    text-align:center;
    border-bottom:1px solid var(--border);
    vertical-align:top;
    font-size:14px;
  }
  th{
    background:#f8fafc;
    font-weight:800;
  }
  tr:last-child td{ border-bottom:none; }
  td.day{
    font-weight:800;
    background:#f8fafc;
    width:160px;
  }
  .slot{
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:center;
  }
  .course{
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 10px;
    background:#fff;
  }
  .course .name{ font-weight:800; }
  .course .status{ font-size:12px; color:var(--muted); margin-top:4px; }
  .forbidden{
    border-color:#fecaca;
    background:#fff1f2;
  }
  .forbidden .status{ color:#991b1b; font-weight:800; }
  .conflictNote{
    margin-top:8px;
    font-size:12px;
    font-weight:900;
    color:#b91c1c;
  }
  .nodata{
    margin-top:14px;
    background:#fff1f2;
    border:1px solid #fecaca;
    color:#991b1b;
    padding:12px;
    border-radius:14px;
    text-align:center;
    font-weight:800;
    white-space:pre-line;
  }
  .footer{
    text-align:center;
    margin:18px 0 8px;
    color:var(--muted);
    font-size:12px;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">TVTC</div>
        <div class="title">
          <h1>بوابة الاستعلام عن جدول الاختبارات</h1>
          <div class="sub">الكلية التقنية بالفرشة — بيانات من Google Sheets عبر Apps Script</div>
        </div>
      </div>
      <div class="pills">
        <div class="pill">المؤسسة: TVTC</div>
        <div class="pill">التشغيل: GitHub Pages</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <input id="traineeId" placeholder="أدخل الرقم التدريبي" inputmode="numeric" />
        <button class="btn" onclick="searchTrainee()">بحث</button>
      </div>
      <div class="hint">ملاحظة: إذا كانت حالة المقرر (حرمان/مطوي قيده) سيظهر تنبيه بعدم دخول الاختبار.</div>

      <div id="studentResult"></div>

      <div class="footer">إذا واجهت عدم ظهور نتيجة، حدّث الصفحة (Ctrl+F5) بعد تحديث Deploy في Apps Script.</div>
    </div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwXBBqk55pwYg4D7cCu0yXfX9kc2hvGMrmxmsszYGVpFPonq9NI9WLTTlDtL8k9r0oYvQ/exec";

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
    const script = document.createElement("script");
    const sep = url.includes("?") ? "&" : "?";

    window[cb] = (data) => {
      try { resolve(data); }
      finally {
        delete window[cb];
        script.remove();
      }
    };

    script.onerror = () => {
      delete window[cb];
      script.remove();
      reject(new Error("JSONP failed"));
    };

    script.src = url + sep + "callback=" + encodeURIComponent(cb);
    document.body.appendChild(script);
  });
}

async function searchTrainee(){
  const id = document.getElementById("traineeId").value.trim();
  const box = document.getElementById("studentResult");
  box.innerHTML = "جاري البحث...";

  if(!id){
    box.innerHTML = `<div class="nodata">من فضلك أدخل الرقم التدريبي</div>`;
    return;
  }

  try{
    const data = await jsonp(`${API_URL}?id=${encodeURIComponent(id)}`);

    if(!data || !data.ok){
      box.innerHTML = `<div class="nodata">${esc((data && data.message) || "لا توجد بيانات")}</div>`;
      return;
    }

    box.innerHTML = renderScheduleTable(data);

  }catch(err){
    box.innerHTML = `<div class="nodata">
فشل الاتصال بالخادم.
- تأكد أن رابط API_URL صحيح (exec)
- تأكد Deploy: Who has access = Anyone
- حدّث الصفحة Ctrl+F5
</div>`;
  }
}

function renderScheduleTable(data){
  const days = Array.isArray(data.days) ? data.days : [];

  let html = `
    <div class="info">
      <div class="box">
        <div class="label">اسم المتدرب</div>
        <div class="value">${esc(data.traineeName)}</div>
      </div>
      <div class="box">
        <div class="label">الرقم التدريبي</div>
        <div class="value">${esc(data.traineeId)}</div>
      </div>
    </div>
  `;

  if(days.length === 0){
    html += `<div class="nodata">لا يوجد جدول اختبارات لهذا المتدرب.</div>`;
    return html;
  }

  html += `
    <table>
      <thead>
        <tr>
          <th>اليوم</th>
          <th>الفترة الأولى <div style="font-size:12px;color:#64748b;margin-top:4px;">8:30 إلى 10:00</div></th>
          <th>الفترة الثانية <div style="font-size:12px;color:#64748b;margin-top:4px;">10:30 إلى 12:00</div></th>
          <th>الفترة الثالثة <div style="font-size:12px;color:#64748b;margin-top:4px;">12:00 إلى 12:30</div></th>
        </tr>
      </thead>
      <tbody>
  `;

  days.forEach(d=>{
    html += `<tr>`;
    html += `<td class="day">${esc(d.dayLabel)}</td>`;

    [1,2,3].forEach(p=>{
      const slot = (d.periods && d.periods[p]) ? d.periods[p] : [];
      if(!slot.length){
        html += `<td>-</td>`;
        return;
      }

      const hasConflict = slot.length > 1;
      html += `<td><div class="slot">`;

      slot.forEach((c, idx)=>{
        const forbidden = !!c.forbidden;
        html += `
          <div class="course ${forbidden ? 'forbidden':''}">
            <div class="name">${esc(c.courseName)}</div>
            <div class="status">${esc(c.status || '')}${forbidden ? ' — لا يمكن دخول الاختبار' : ''}</div>
          </div>
        `;
      });

      if(hasConflict){
        html += `<div class="conflictNote">تنبيه: لديك أكثر من مقرر في نفس الفترة.</div>`;
      }

      html += `</div></td>`;
    });

    html += `</tr>`;
  });

  html += `</tbody></table>`;
  return html;
}

// Enter = بحث
document.getElementById("traineeId").addEventListener("keyup", function(e){
  if(e.key === "Enter") searchTrainee();
});
</script>
</body>
</html>
